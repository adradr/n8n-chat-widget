window.ChatWidgetDefaultConfig={webhook:{url:"",route:"",streaming:!0,timeout:0},branding:{logo:"",name:"",welcomeText:"Hello! 👋 How can I help you today?",responseTimeText:"Typically replies in seconds",poweredBy:{text:"",link:""}},style:{primaryColor:"#854fff",secondaryColor:"#6b3fd4",position:"right",backgroundColor:"#ffffff",fontColor:"#333333"},labels:{inputPlaceholder:"Type your message here...",waitingForResponse:"Waiting for response...",newChatButton:"Send us a message",clearHistoryTooltip:"Clear conversation",closeButtonTooltip:"Close",errorMessage:"An error occurred while receiving the response.",connectionErrorMessage:"Connection error. Please check your internet connection.",confirmClearHistory:"Are you sure you want to clear the entire conversation history?"},initialMessage:{enabled:!1,text:"",loadPreviousSession:!1},loadingMessages:[{emoji:"💭",text:"Thinking..."},{emoji:"🔍",text:"Processing your request..."},{emoji:"⏳",text:"Just a moment..."},{emoji:"🎯",text:"Preparing response..."}],loadingMessageDelay:5e3,loadingMessageInterval:3e3,debug:!1},window.ChatWidgetConfig=window.ChatWidgetConfig||{},window.ChatWidgetConfig={webhook:{...window.ChatWidgetDefaultConfig.webhook,...window.ChatWidgetConfig.webhook},branding:{...window.ChatWidgetDefaultConfig.branding,...window.ChatWidgetConfig.branding,poweredBy:{...window.ChatWidgetDefaultConfig.branding.poweredBy,...window.ChatWidgetConfig.branding?.poweredBy||{}}},style:{...window.ChatWidgetDefaultConfig.style,...window.ChatWidgetConfig.style},labels:{...window.ChatWidgetDefaultConfig.labels,...window.ChatWidgetConfig.labels},initialMessage:{...window.ChatWidgetDefaultConfig.initialMessage,...window.ChatWidgetConfig.initialMessage},loadingMessages:void 0!==window.ChatWidgetConfig.loadingMessages?window.ChatWidgetConfig.loadingMessages:window.ChatWidgetDefaultConfig.loadingMessages,loadingMessageDelay:void 0!==window.ChatWidgetConfig.loadingMessageDelay?window.ChatWidgetConfig.loadingMessageDelay:window.ChatWidgetDefaultConfig.loadingMessageDelay,loadingMessageInterval:void 0!==window.ChatWidgetConfig.loadingMessageInterval?window.ChatWidgetConfig.loadingMessageInterval:window.ChatWidgetDefaultConfig.loadingMessageInterval,debug:void 0!==window.ChatWidgetConfig.debug?window.ChatWidgetConfig.debug:window.ChatWidgetDefaultConfig.debug},function(){"use strict";if(window.N8NChatWidgetInitialized)return;window.N8NChatWidgetInitialized=!0;const e=window.ChatWidgetConfig,t=window!==window.parent,n=(...t)=>{e.debug&&console.log("[Chat Widget]",...t)},o=(...t)=>{e.debug&&console.error("[Chat Widget]",...t)},s=(...t)=>{e.debug&&console.warn("[Chat Widget]",...t)};let a=localStorage.getItem("chatbot-session-id");function i(){return crypto.randomUUID()}function r(e){try{localStorage.setItem("chatbot-history",JSON.stringify(e))}catch(e){s("Failed to save chat history:",e)}}function l(){try{const e=localStorage.getItem("chatbot-history");return e?JSON.parse(e):[]}catch(e){return s("Failed to load chat history:",e),[]}}function c(e,t){if(!e)return s("Skipping empty/undefined message in history"),null;const n=l(),o={id:i(),text:e,type:t,timestamp:(new Date).toISOString(),sessionId:a};return n.push(o),r(n),o}a?n("Using existing session ID from localStorage:",a):(a=i(),localStorage.setItem("chatbot-session-id",a),n("Generated new session ID:",a)),function(){const e=l(),t=e.filter(e=>!!(e.text&&e.type&&e.sessionId)||(s("Removing invalid history entry:",e),!1));t.length!==e.length&&(n("Cleaned up history, removed",e.length-t.length,"invalid entries"),r(t))}();const d=document.createElement("div");d.className="n8n-chat-widget",d.style.setProperty("--n8n-chat-primary-color",e.style.primaryColor),d.style.setProperty("--n8n-chat-secondary-color",e.style.secondaryColor),d.style.setProperty("--n8n-chat-background-color",e.style.backgroundColor),d.style.setProperty("--n8n-chat-font-color",e.style.fontColor);const g=document.createElement("div");g.className="chat-container"+("left"===e.style.position?" position-left":"");const p=`\n        <div class="brand-header">\n            <img src="${e.branding.logo}" alt="${e.branding.name}">\n            <button class="close-button" title="${e.labels.closeButtonTooltip}">×</button>\n        </div>\n        <div class="new-conversation">\n            <h2 class="welcome-text">${e.branding.welcomeText}</h2>\n            <button class="new-chat-btn">\n                <svg class="message-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\n                    <path fill="currentColor"\n                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z" />\n                </svg>\n                ${e.labels.newChatButton}\n            </button>\n            <p class="response-text">${e.branding.responseTimeText}</p>\n        </div>\n    `,u=`\n        <div class="chat-interface">\n            <div class="brand-header">\n                <img src="${e.branding.logo}" alt="${e.branding.name}">\n                <button class="clear-history-btn" title="${e.labels.clearHistoryTooltip}">\n                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">\n                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>\n                    </svg>\n                </button>\n                <button class="close-button" title="${e.labels.closeButtonTooltip}">×</button>\n            </div>\n            <div class="chat-messages">\n            </div>\n            <div class="chat-input">\n                <textarea placeholder="${e.labels.inputPlaceholder}" rows="1"></textarea>\n                <button type="submit">\n                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">\n                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n                    </svg>\n                </button>\n            </div>\n            <div class="chat-footer">\n                <a href="${e.branding.poweredBy.link}" target="_blank">${e.branding.poweredBy.text}</a>\n            </div>\n        </div>\n    `;g.innerHTML=p+u;const h=document.createElement("button");h.className="chat-toggle"+("left"===e.style.position?" position-left":""),h.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\n            <path\n                d="M12 2C6.477 2 2 6.477 2 12c0 1.821.487 3.53 1.338 5L2.5 21.5l4.5-.838A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18c-1.476 0-2.886-.313-4.156-.878l-3.156.586.586-3.156A7.962 7.962 0 014 12c0-4.411 3.589-8 8-8s8 3.589 8 8-3.589 8-8 8z" />\n        </svg>',d.appendChild(g),d.appendChild(h),t&&(d.classList.add("in-iframe"),n("Widget detected in iframe, applying iframe-specific styles")),document.body.appendChild(d);const m=g.querySelector(".new-chat-btn"),y=g.querySelector(".chat-interface"),f=g.querySelector(".chat-messages"),w=g.querySelector("textarea"),b=g.querySelector('button[type="submit"]');function v(e){try{if(n("Formatting message, input text:",e),!e)return s("Received undefined/null text, returning empty string"),"";let t=e.replace(/\n/g,"<br>");return t=t.replace(/^### (.+?)$/gm,"<h3>$1</h3>"),t=t.replace(/^## (.+?)$/gm,"<h2>$1</h2>"),t=t.replace(/^# (.+?)$/gm,"<h1>$1</h1>"),t=t.replace(/^### (.+?)<br>/gm,"<h3>$1</h3><br>"),t=t.replace(/^## (.+?)<br>/gm,"<h2>$1</h2><br>"),t=t.replace(/^# (.+?)<br>/gm,"<h1>$1</h1><br>"),t=t.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>"),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t=t.replace(/~~(.*?)~~/g,"<del>$1</del>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>'),t=t.replace(/(^|\s)(https?:\/\/[^\s<>"]+)/g,'$1<a href="$2" target="_blank">$2</a>'),t=t.replace(/^> (.+?)(<br>|$)/gm,"<blockquote>$1</blockquote>"),t=t.replace(/^(---+|===+|[*]{3,})(<br>|$)/gm,"<hr>"),t=t.replace(/^[*-] (.+?)(<br>|$)/gm,"<li>$1</li>"),t=t.replace(/^(\d+)\. (.+?)(<br>|$)/gm,"<li>$2</li>"),t=t.replace(/(<li>.*?<\/li>)(<br>)*/g,function(e){return e.includes("</li><li>")?"<ul>"+e.replace(/<br>/g,"")+"</ul>":e}),t=t.replace(/<br>(<h[1-6]>)/g,"$1"),t=t.replace(/(<\/h[1-6]>)<br>/g,"$1"),t=t.replace(/<br>(<ul>|<ol>|<li>|<blockquote>|<pre>|<hr>)/g,"$1"),t=t.replace(/(<\/ul>|<\/ol>|<\/li>|<\/blockquote>|<\/pre>|<hr>)<br>/g,"$1"),n("Formatted message output:",t),t}catch(t){return o("Error in formatBotMessage:",t),e}}f.addEventListener("click",e=>{const t=e.target.closest("a");t&&t.href&&(e.preventDefault(),e.stopPropagation(),window.open(t.href,"_blank"))},!0);const C=e.loadingMessages||[];async function S(t){const s={action:"sendMessage",sessionId:a,route:e.webhook.route,chatInput:t,metadata:{userId:"",streaming:!1!==e.webhook.streaming}};c(t,"user");const i=document.createElement("div");i.className="chat-message user",i.innerHTML=t.replace(/\n/g,"<br>"),f.appendChild(i);const r=function(){const e=document.createElement("div");return e.className="chat-message bot typing-indicator",e.innerHTML='\n            <div class="typing-dots">\n                <span></span>\n                <span></span>\n                <span></span>\n            </div>\n        ',e}();f.appendChild(r),setTimeout(()=>{f.scrollTop=f.scrollHeight},50),w.disabled=!0,b.disabled=!0,w.placeholder=e.labels.waitingForResponse||"Waiting for response...";let l="",d=null,g=null,p=!1,u=!1,h=null,m=!1,y=[],S=!1;const T=()=>{m?m=!1:u=!(f.scrollHeight-f.scrollTop-f.clientHeight<2)};f.addEventListener("scroll",T,{passive:!0}),setTimeout(()=>{p||h||!r.parentNode||(h=function(t,n){if(!C||0===C.length)return{cleanup:()=>{},waitForMinimumDisplay:()=>Promise.resolve()};let o=null,s=null,a=!0,i=null;o=document.createElement("div"),o.style.marginTop="10px",o.style.opacity="0",o.style.transition="opacity 0.5s ease-in-out",o.style.fontSize="14px",o.style.color="#666",t.appendChild(o);const r=()=>{if(!a||!o)return;const t=C[Math.floor(Math.random()*C.length)];o.style.opacity="0",setTimeout(()=>{a&&o&&(o.innerHTML=`<span style="margin-right: 8px;">${t.emoji}</span><em>${t.text}</em>`,setTimeout(()=>{o&&(o.style.opacity="0.8",n&&(n.scrollTop=n.scrollHeight))},50))},300),i=Date.now(),a&&(s=setTimeout(r,e.loadingMessageInterval||3e3))};return setTimeout(()=>{r(),n&&setTimeout(()=>{n.scrollTop=n.scrollHeight},100)},500),{cleanup:()=>{a=!1,s&&clearTimeout(s),o&&o.parentNode&&o.remove()},waitForMinimumDisplay:async()=>{if(i){const e=Date.now()-i,t=3e3;e<t&&await new Promise(n=>setTimeout(n,t-e))}}}}(r,f))},e.loadingMessageDelay||5e3);const M=async e=>{if("string"==typeof e&&e.trim().startsWith("{")&&e.includes('"output"'))try{const t=JSON.parse(e);if(void 0!==t.output||void 0!==t.intermediateSteps)return void n("Filtering out JSON response sent as chunk")}catch(e){}p||(p=!0,h&&(await h.waitForMinimumDisplay(),h.cleanup(),h=null),r.remove(),g=document.createElement("div"),g.className="chat-message bot streaming",f.appendChild(g),d=document.createElement("span"),d.className="streaming-cursor",g.appendChild(d)),l+=e,function(e,t,n){const o=v(t);n&&n.parentNode===e&&n.remove(),e.innerHTML=o,n&&e.appendChild(n)}(g,l,d),u||(m=!0,f.scrollTop=f.scrollHeight)},k=async()=>{if(!S&&0!==y.length){for(S=!0;y.length>0;){const e=y.shift();await M(e)}S=!1}},N=new AbortController;let x=null;e.webhook.timeout&&e.webhook.timeout>0?x=setTimeout(()=>{n("Request timeout after",e.webhook.timeout,"ms"),N.abort()},e.webhook.timeout):n("No timeout set for streaming request");try{if(n("Sending message with streaming:",!1!==e.webhook.streaming),n("Request data:",s),!1!==e.webhook.streaming){n("Attempting streaming request to:",e.webhook.url);const t=await fetch(e.webhook.url,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream, application/x-ndjson, application/json"},body:JSON.stringify(s),signal:N.signal});if(n("Response status:",t.status),n("Response content-type:",t.headers.get("content-type")),t.body){n("Reading response as stream");const e=t.body.getReader(),s=new TextDecoder;let a="";try{for(;;){const{done:t,value:o}=await e.read();if(t){if(n("Stream ended"),a.trim()){const e=a.trim().split("\n");for(const t of e)if(t.trim())try{const e=JSON.parse(t);void 0!==e.output||void 0!==e.intermediateSteps?n("Ignoring final JSON response in buffer"):"item"===e.type&&e.content&&(y.push(e.content),k())}catch(e){n("Could not parse buffered line:",t)}}await k(),d&&d.parentNode&&(d.remove(),d=null),g&&g.classList.remove("streaming");break}a+=s.decode(o,{stream:!0}),n("Received chunk, buffer now:",a);const i=a.split("\n");a=i.pop()||"";for(const e of i)if(e.trim())if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t){n("Received [DONE] signal");break}try{const e=JSON.parse(t);(e.chunk||e.content)&&(y.push(e.chunk||e.content),k())}catch(e){n("Failed to parse SSE data:",t)}}else try{const t=JSON.parse(e);n("Processing streamed chunk:",t),void 0!==t.output||void 0!==t.intermediateSteps?n("Received final JSON response, ignoring for streaming (already have content)"):"item"===t.type&&t.content?(y.push(t.content),k()):"begin"===t.type?n("Stream begin"):"end"===t.type&&n("Stream end signal")}catch(t){n("Failed to parse line as JSON:",e)}}}catch(e){throw o("Stream reading error:",e),e}}else{n("Fallback to regular JSON response");try{const e=await t.text();n("Raw response text:",e),h&&(await h.waitForMinimumDisplay(),h.cleanup(),h=null),r.remove(),g=document.createElement("div"),g.className="chat-message bot",f.appendChild(g);const s=e.trim().split("\n");if(s.length>1){n("Detected NDJSON format, processing chunks");for(const e of s)if(e.trim())try{const t=JSON.parse(e);n("Processing chunk:",t),"item"===t.type&&t.content?l+=t.content:"begin"===t.type?n("Stream begin"):"end"===t.type&&n("Stream end")}catch(t){o("Failed to parse line as JSON:",e,t)}g.innerHTML=v(l)}else try{const t=JSON.parse(e);n("Received JSON data:",t),l=Array.isArray(t)?t[0].output:t.output,g.innerHTML=v(l)}catch(t){o("Failed to parse response as JSON:",t),n("Treating response as plain text"),l=e,g.innerHTML=v(l)}f.scrollTop=f.scrollHeight}catch(e){throw o("Failed to read response text:",e),e}}}else{n("Non-streaming mode");const t=await fetch(e.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:N.signal});n("Response status:",t.status);try{const e=await t.text();let s;n("Raw response text:",e),h&&(await h.waitForMinimumDisplay(),h.cleanup(),h=null),r.remove(),g=document.createElement("div"),g.className="chat-message bot",f.appendChild(g);try{s=JSON.parse(e)}catch(t){return o("Failed to parse response as JSON:",t),n("Treating response as plain text"),l=e,g.innerHTML=v(l),void(f.scrollTop=f.scrollHeight)}n("Received data:",s),l=Array.isArray(s)?s[0].output:s.output,g.innerHTML=v(l),f.scrollTop=f.scrollHeight}catch(e){throw o("Failed to read response text:",e),e}}d&&d.parentNode&&(d.remove(),d=null),g&&g.classList.remove("streaming"),c(l,"agent"),x&&clearTimeout(x),f.removeEventListener("scroll",T)}catch(t){x&&clearTimeout(x),h&&(h.cleanup(),h=null);const n="AbortError"===t.name;o("Error details:",{message:t.message,stack:t.stack,name:t.name,isTimeout:n}),o("Full error object:",t),r.parentNode&&r.remove(),g||(g=document.createElement("div"),g.className="chat-message bot",f.appendChild(g));const s=n?`<em>${e.labels.connectionErrorMessage||"Connection timeout. Please try again later."}</em>`:`<em>${e.labels.errorMessage||"An error occurred while receiving the response."}</em>`;g.innerHTML=s,g.classList.remove("streaming"),d&&d.parentNode&&d.remove()}finally{f.removeEventListener("scroll",T),w.disabled=!1,b.disabled=!1,w.placeholder=e.labels.inputPlaceholder||"Type your message here...",w.focus()}}m.addEventListener("click",async function(){if(n("Starting new conversation"),g.querySelector(".brand-header").style.display="none",g.querySelector(".new-conversation").style.display="none",y.classList.add("active"),function(){const e=l().filter(e=>e.sessionId===a);return 0!==e.length&&(f.innerHTML="",e.forEach(e=>{if(!e.text)return void s("Skipping history entry with no text:",e);const t=document.createElement("div"),n="agent"===e.type?"bot":e.type;t.className=`chat-message ${n}`,"agent"===e.type?t.innerHTML=v(e.text):t.innerHTML=e.text.replace(/\n/g,"<br>"),f.appendChild(t)}),f.scrollTop=f.scrollHeight,!0)}())n("History restored from localStorage");else{if(n("No history found, starting fresh conversation"),e.initialMessage&&e.initialMessage.enabled&&e.initialMessage.text){n("Showing configured initial message");const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=v(e.initialMessage.text),f.appendChild(t),f.scrollTop=f.scrollHeight,c(e.initialMessage.text,"agent")}if(e.initialMessage&&e.initialMessage.loadPreviousSession){n("Loading previous session from webhook"),n("Current session ID being used:",a);const t={action:"loadPreviousSession",sessionId:a,route:e.webhook.route,chatInput:"",metadata:{userId:"",streaming:!1}};n("Sending loadPreviousSession request:",t),n("Full request body:",JSON.stringify(t,null,2)),w.disabled=!0,b.disabled=!0,w.placeholder=e.labels.waitingForResponse||"Waiting for response...";try{const s=await fetch(e.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});n("LoadPreviousSession response status:",s.status);const l=await s.json();if(n("LoadPreviousSession response data:",l),l?.data&&Array.isArray(l.data)){n("Reconstructing chat history from LangChain messages"),f.innerHTML="";const e=[];l.data.forEach((t,n)=>{if(t.id&&t.kwargs&&t.kwargs.content){const o=t.id[2],s=t.kwargs.content,r="HumanMessage"===o,c=r?"user":"agent",d={id:i(),text:s,type:c,timestamp:new Date(Date.now()-6e4*(l.data.length-n)).toISOString(),sessionId:a};e.push(d);const g=document.createElement("div");g.className="chat-message "+(r?"user":"bot"),g.innerHTML=r?s.replace(/\n/g,"<br>"):v(s),f.appendChild(g)}}),e.length>0&&(r(e),n(`Reconstructed ${e.length} messages from previous session`)),f.scrollTop=f.scrollHeight}else{let e;if(Array.isArray(l)?e=l[0]?.output:l?.output?e=l.output:l?.content&&("error"===l.type?(o("Error from webhook:",l.content),e=null):e=l.content),e&&e.trim()){c(e,"agent");const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=v(e),f.appendChild(t),f.scrollTop=f.scrollHeight}else n("No message text received from loadPreviousSession, skipping bubble creation")}}catch(e){o("Error loading previous session:",e)}finally{w.disabled=!1,b.disabled=!1,w.placeholder=e.labels.inputPlaceholder||"Type your message here...",w.focus()}}else n("Not loading previous session, chat ready for user input"),w.focus()}}),b.addEventListener("click",()=>{const e=w.value.trim();e&&(S(e),w.value="")}),w.addEventListener("keypress",e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=w.value.trim();t&&(S(t),w.value="")}}),h.addEventListener("click",()=>{g.classList.toggle("open")});g.querySelectorAll(".close-button").forEach(e=>{e.addEventListener("click",()=>{g.classList.remove("open")})});const T=g.querySelector(".clear-history-btn");T&&T.addEventListener("click",()=>{confirm(e.labels.confirmClearHistory||"Are you sure you want to clear the entire conversation history?")&&(localStorage.removeItem("chatbot-history"),f.innerHTML="",a=i(),localStorage.setItem("chatbot-session-id",a))})}();